using UnityEngine;
using UnityEngine.U2D.Animation;
using System.Collections.Generic;
using System.Collections;
using UnityEngine.SceneManagement;

public class SwitchController : MonoBehaviour
{
    [Header("Persistence")]
    [Tooltip("Unique ID per switch so checkpoint restore can find it.")]
    public string persistentID;

    [Header("Group Settings")]
    [Tooltip("Add all switches in this puzzle group (including this one).")]
    public List<SwitchController> allSwitches; 
    public BarrierController barrier;

    [Header("Camera Focus")]
    public Transform focusTarget;

    [Header("Sprite Resolver")]
    public SpriteResolver spriteResolver;

    [Header("Audio")]
    public AudioClip[] hitToActivate;
    public AudioClip[] hitToDeactivate;
    private AudioSource audioSource;

    [Header("Toggle Settings")]
    [Tooltip("If true, this switch can be turned ON and OFF repeatedly.")]
    public bool isToggleSwitch = false;
    private bool isActivated = false;
    private string autoGeneratedID;

    public bool IsActivated => isActivated;

    // Platform control
    [Header("Platform Toggle")]
    [Tooltip("Platforms ACTIVE when switch is ON")]
    public List<TempPlatform> platformsForOnState;

    [Tooltip("Platforms ACTIVE when switch is OFF")]
    public List<TempPlatform> platformsForOffState;

    private void Awake()
    {
        if (spriteResolver == null)
            spriteResolver = GetComponent<SpriteResolver>();

        audioSource = GetComponent<AudioSource>();

        if (allSwitches.Count == 0)
            allSwitches.Add(this);

        // If sprite resolver exists, detect initial activation state from its category
        if (spriteResolver != null)
        {
            string cat = spriteResolver.GetCategory();

            if (cat == "On")
                isActivated = true;
            else if (cat == "Off")
                isActivated = false;
        }

        UpdateSprite();

        // Apply initial platform layout
        if (isActivated)
            ApplyOnState();
        else
            ApplyOffState();

        LoadStateFromCheckpoint();
    }

    private void OnTriggerEnter2D(Collider2D other)
    {
        if (!other.CompareTag("PlayerWeapon"))
            return;

        Debug.Log("Switch hit! isActivated = " + isActivated + ", isToggle = " + isToggleSwitch);
        if (isToggleSwitch)
        {
            ToggleSwitch();
        }
        else
        {
            DeactivateSwitch(); // one way activation
        }
    }

    // Toggle switch
    private void ToggleSwitch()
    {
        isActivated = !isActivated;

        // Determine which sound to play
        PlaySound(isActivated ? "Activate" : "Deactivate");

        UpdateSprite();

        if (isActivated)
            ApplyOnState();
        else
            ApplyOffState();

        PersistStateToCheckpoint();
    }

    // One way switch
    public void DeactivateSwitch()
    {
        if (!isActivated)
            return; // already off, prevent double trigger

        isActivated = false;

        PlaySound("Deactivate");
        UpdateSprite();

        ApplyOffState();
        PersistStateToCheckpoint();

        if (AreAllSwitchesDeactivated())
            StartCoroutine(HandleBarrierSequence());
    }

    private bool AreAllSwitchesDeactivated()
    {
        foreach (var s in allSwitches)
        {
            if (s.isActivated)
                return false;
        }
        return true;
    }

    // Control platforms
    private void ApplyOnState()
    {
        // ON platforms respawn
        foreach (var p in platformsForOnState)
            p?.TriggerRespawn();

        // OFF platforms collapse
        foreach (var p in platformsForOffState)
            p?.TriggerCollapse();
    }

    private void ApplyOffState()
    {
        // OFF platforms respawn
        foreach (var p in platformsForOffState)
            p?.TriggerRespawn();

        // ON platforms collapse
        foreach (var p in platformsForOnState)
            p?.TriggerCollapse();
    }

    // Sprite and audio
    private void UpdateSprite()
    {
        if (spriteResolver == null) return;

        // Your existing categories/labels
        if (isActivated)
            spriteResolver.SetCategoryAndLabel("On", "tileset_325");
        else
            spriteResolver.SetCategoryAndLabel("Off", "tileset_393");
    }

    public void RestoreState(bool activated, bool shouldPersist = true)
    {
        isActivated = activated;
        UpdateSprite();

        if (isActivated)
            ApplyOnState();
        else
            ApplyOffState();

        if (shouldPersist)
            PersistStateToCheckpoint();
    }

    private void PersistStateToCheckpoint()
    {
        var id = GetPersistenceKey();
        if (string.IsNullOrEmpty(id))
            return;

        CheckpointGameData.SetSwitchState(id, isActivated);
    }

    public string GetPersistenceKey()
    {
        if (!string.IsNullOrEmpty(persistentID))
            return persistentID;

        if (string.IsNullOrEmpty(autoGeneratedID))
        {
            autoGeneratedID = $"{SceneManager.GetActiveScene().name}:{BuildHierarchyPath()}";
        }

        return autoGeneratedID;
    }

    private string BuildHierarchyPath()
    {
        var segments = new List<string>();
        Transform current = transform;

        while (current != null)
        {
            segments.Add(current.name);
            current = current.parent;
        }

        segments.Reverse();
        return string.Join("/", segments);
    }

    private void LoadStateFromCheckpoint()
    {
        if (!CheckpointGameData.hasCheckpoint)
            return;

        if (CheckpointGameData.sceneName != SceneManager.GetActiveScene().name)
            return;

        var id = GetPersistenceKey();
        if (string.IsNullOrEmpty(id))
            return;

        foreach (var state in CheckpointGameData.switchStates)
        {
            if (state.switchID != id)
                continue;

            RestoreState(state.isActivated, false);
            break;
        }

    }

    private void PlaySound(string activation)
    {
        if (audioSource == null) 
            return;

        if (activation == "Activate")
        {
            if (hitToActivate != null && hitToActivate.Length > 0)
            {
                int randomIndex = Random.Range(0, hitToActivate.Length);
                audioSource.PlayOneShot(hitToActivate[randomIndex]);
            }
        }
        else if (activation == "Deactivate")
        {
            if (hitToDeactivate != null && hitToDeactivate.Length > 0)
            {
                int randomIndex = Random.Range(0, hitToDeactivate.Length);
                audioSource.PlayOneShot(hitToDeactivate[randomIndex]);
            }
        }
    }

    // Barrier
    private IEnumerator HandleBarrierSequence()
    {
        GameFreezeManager.Instance?.FreezeGame();

        if (focusTarget != null && CameraFocusController.Instance != null)
        {
            CameraFocusController.Instance.FocusOnTarget(focusTarget);
            yield return new WaitForSecondsRealtime(1f);
        }

        barrier?.DeactivateBarrier();

        yield return new WaitForSecondsRealtime(1.5f);

        if (CameraFocusController.Instance != null)
            CameraFocusController.Instance.ReturnToPlayer();

        yield return new WaitForSecondsRealtime(0.5f);

        GameFreezeManager.Instance?.UnfreezeGame();
    }
}